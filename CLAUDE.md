# Documentor - Claude Code Context

AI-powered PDF document classification and organization tool using vision LLMs via OpenRouter.

## Quick Reference

**Run**: `documentor [--profile NAME] <task> <processed_path> [options]`
**Install**: `uv pip install -e .`
**Debug classification**: `python scripts/debug_classification.py <pdf_path>`
**Check hashes**: `check-hash <pdf_path>`
**Profile docs**: `profiles/README.md` - Multi-environment configuration system

## Architecture

### Two-Phase Extraction Pipeline
1. **Phase 1 - Raw Extraction** (`classify_pdf_document`, line 567): Renders first 2 pages as JPEG, sends to LLM with vision, extracts metadata EXACTLY as appears on document
2. **Phase 2 - Normalization** (`normalize_metadata`, line 487): Maps raw values to canonical enums (e.g., "Anthropic, PBC" -> "Anthropic")

### Two-Tier Hashing
- **Fast hash** (`hash_file_fast`, line 348): SHA256 of raw bytes, 8 chars - for quick duplicate filtering
- **Content hash** (`hash_file`, line 359): Renders all pages at 150 DPI, hashes pixel data - detects true duplicates even if PDF metadata differs

### Dynamic Enums
Document types and issuing parties are loaded dynamically from existing metadata JSON files in the processed directory. Falls back to hardcoded lists if directory doesn't exist. Always includes `$UNKNOWN$` sentinel.

## Key Files

| File | Purpose | Key Lines |
|------|---------|-----------|
| `main.py` | Core app (~1666 lines) | Entry: 1578, Tasks: 1167+ |
| `main.py` | Pydantic models | `DocumentMetadataRaw`: 217, `DocumentMetadata`: 238 |
| `main.py` | Classification | `classify_pdf_document`: 567, `normalize_metadata`: 487 |
| `main.py` | Hashing | `hash_file_fast`: 348, `hash_file`: 359 |
| `scripts/debug_classification.py` | Debug LLM calls | Full API response with images |
| `scripts/check_hash.py` | Verify hashes | CLI: `check-hash` |
| `documentor/gmail.py` | Gmail API client | `GmailDownloader`: 44, `download_gmail_attachments`: 418 |

## Data Models (Pydantic)

```python
DocumentMetadataRaw    # Phase 1: exact text from document
DocumentMetadataInput  # With enum validation
DocumentMetadata       # Full: hashes, timestamps, raw values
```

Fields: `issue_date`, `document_type`, `issuing_party`, `service_name`, `total_amount`, `total_amount_currency`, `confidence`, `reasoning`, `content_hash`, `file_hash`, `create_date`, `update_date`, `document_type_raw`, `issuing_party_raw`

## File Naming Convention

Pattern: `YYYY-MM-DD - document-type - issuing-party - [service] - [amount currency] - hash.pdf`
Example: `2025-01-02 - invoice - anthropic - claude-api - 120 eur - a1b2c3d4.pdf`

Generated by `file_name_from_metadata()` (line 447). All components lowercase, sanitized.

## CLI Tasks

| Task | Purpose | Required Options |
|------|---------|------------------|
| `extract_new` | Process new PDFs from raw folder | `--raw_path` |
| `rename_files` | Rename based on metadata | - |
| `validate_metadata` | Check consistency | - |
| `export_excel` | Export to Excel | `--excel_output_path` |
| `copy_matching` | Copy files matching regex | `--regex_pattern`, `--copy_dest_folder` |
| `export_all_dates` | Export by date range | `--export_base_dir` |
| `check_files_exist` | Validate against schema | `--check_schema_path` (optional) |
| `pipeline` | Full end-to-end workflow | `--export_date` (optional) |
| `gmail_download` | Download email attachments from Gmail | None (uses .env) |

## Configuration

### Profile-Based (Recommended)

**Current setup**: `profiles/default.yaml` (migrated from `.env`)

```yaml
profile:
  name: "default"
  description: "Default configuration"

paths:
  raw: ["/Users/tsilva/Desktop/Takeout/"]
  processed: "/Users/tsilva/Google Drive/My Drive/documentor-puzzle/processed/"
  export: "/Users/tsilva/Google Drive/My Drive/documentor-puzzle/export/"

openrouter:
  model_id: "google/gemini-2.5-flash"
  api_key: "${OPENROUTER_API_KEY}"  # References .env for security

document_types:
  predefined: null  # Dynamic loading from processed metadata
```

**Usage**:
```bash
documentor --profile default extract_new /path/to/processed
documentor --profile personal pipeline
documentor extract_new /path/to/processed  # Auto-uses default.yaml if available
```

**Multiple environments**: Create `profiles/personal.yaml`, `profiles/work.yaml`, etc. from templates in `profiles/*.yaml.example`

**Full docs**: See `profiles/README.md` for complete YAML schema and examples

### Legacy .env (Deprecated but Supported)

Still works for backward compatibility. `.env` at repo root:

```env
OPENROUTER_MODEL_ID=google/gemini-2.5-flash
OPENROUTER_API_KEY=sk-or-v1-...
RAW_FILES_DIR=/path/to/raw;/optional/path2
PROCESSED_FILES_DIR=/path/to/processed
EXPORT_FILES_DIR=/path/to/export
```

**Note**: If both profiles and .env exist, profiles take precedence when `--profile` is specified.

### Config Files

**Config files** in `config/` directory (gitignored, copy from `.example` files):
- `passwords.txt` - ZIP extraction passwords
- `file_check_validations.json` - File validation schema
- `document_types.json` - Fallback document types for classification
- `gmail_credentials.json` - Gmail OAuth2 client credentials (from Google Cloud Console)
- `gmail_settings.json` - Gmail download settings (legacy, use profile settings instead)
- `gmail_token.json` - Auto-generated OAuth2 refresh token

## Code Patterns

- **Progress bars**: Always use `tqdm` for loops over files
- **Error handling**: Log failures to `classification_failures.log` via `failure_logger`
- **Validators**: Pydantic `@field_validator` for normalization (currency symbols, amounts, dates)
- **LLM calls**: Use `tool_choice` for structured output, temperature=0 for determinism
- **Fallbacks**: Always fall back to `$UNKNOWN$` for unrecognized values

## Common Development Tasks

**Add new document type**: Just process documents with that type - it's automatically added from metadata
**Add new issuing party**: Same - dynamically loaded from processed metadata
**Debug classification failure**: `python scripts/debug_classification.py <pdf>` shows full LLM response
**Verify duplicate detection**: `check-hash <pdf>` shows both fast and content hashes

## Testing

No test suite currently. Debug scripts available in `scripts/`.

## Dependencies

Core: `openai`, `PyMuPDF (fitz)`, `pandas`, `pydantic`, `pyyaml`, `pillow`, `tqdm`, `openpyxl`, `python-dotenv`
Gmail: `google-api-python-client`, `google-auth-httplib2`, `google-auth-oauthlib`
Build: `hatchling`, Package manager: `uv`
