# Documentor - Claude Code Context

AI-powered PDF document classification and organization tool using vision LLMs via OpenRouter.

## Quick Reference

**Run**: `python main.py [--profile NAME] <task> <processed_path> [options]`
**Install**: `uv pip install -e .`
**Debug classification**: `python scripts/debug_classification.py <pdf_path>`
**Check hashes**: `python scripts/check_hash.py <pdf_path>`
**Profile docs**: `profiles/README.md` - Multi-environment configuration system

## Architecture

### Two-Phase Extraction Pipeline
1. **Phase 1 - Raw Extraction** (`classify_pdf_document`): Renders first 2 pages as JPEG, sends to LLM with vision, extracts metadata EXACTLY as appears on document
2. **Phase 2 - Normalization** (`normalize_metadata`): Maps raw values to canonical enums using two-tier lookup

### Two-Tier Normalization (Mapping Persistence)
Ensures deterministic normalization by persisting successful mappings:

1. **TIER 1 - Mappings Lookup** (`MappingsManager`): Check `config/mappings.yaml` for known raw → canonical mappings (instant, no LLM call)
2. **TIER 2 - LLM Fallback**: If not found, use LLM to normalize, then save mapping for reuse

```
Raw: "Anthropic, PBC" → Check mappings.yaml → Found! → Return "anthropic" (no LLM)
Raw: "New Vendor Inc" → Check mappings.yaml → Not found → LLM → "new-vendor" → Save to mappings.yaml
```

Mappings file structure:
- `confirmed`: User-validated mappings (trusted)
- `auto`: LLM-generated mappings (pending review via `review_mappings` task)
- `canonicals`: Master list of valid canonical values

### Two-Tier Hashing
- **Fast hash** (`hash_file_fast`, line 348): SHA256 of raw bytes, 8 chars - for quick duplicate filtering
- **Content hash** (`hash_file`, line 359): Renders all pages at 150 DPI, hashes pixel data - detects true duplicates even if PDF metadata differs

### Dynamic Enums
Document types and issuing parties are loaded dynamically from existing metadata JSON files in the processed directory. Falls back to hardcoded lists if directory doesn't exist. Always includes `$UNKNOWN$` sentinel.

## Key Files

| File | Purpose | Key Lines |
|------|---------|-----------|
| `main.py` | Core app | Entry point, CLI tasks |
| `documentor/models.py` | Pydantic models | `DocumentMetadataRaw`, `DocumentMetadata` |
| `documentor/llm.py` | LLM classification | `normalize_metadata` with two-tier lookup |
| `documentor/mappings.py` | Mapping persistence | `MappingsManager` class |
| `documentor/hashing.py` | File hashing | `hash_file_fast`, `hash_file_content` |
| `scripts/debug_classification.py` | Debug LLM calls | Full API response with images |
| `scripts/check_hash.py` | Verify hashes | CLI: `check-hash` |
| `documentor/gmail.py` | Gmail API client | `GmailDownloader`, `download_gmail_attachments` |

## Data Models (Pydantic)

```python
DocumentMetadataRaw    # Phase 1: exact text from document
DocumentMetadataInput  # With enum validation
DocumentMetadata       # Full: hashes, timestamps, raw values
```

Fields: `issue_date`, `document_type`, `issuing_party`, `service_name`, `total_amount`, `total_amount_currency`, `confidence`, `reasoning`, `content_hash`, `file_hash`, `create_date`, `update_date`, `document_type_raw`, `issuing_party_raw`

## File Naming Convention

Pattern: `YYYY-MM-DD - document-type - issuing-party - [service] - [amount currency] - hash.pdf`
Example: `2025-01-02 - invoice - anthropic - claude-api - 120 eur - a1b2c3d4.pdf`

Generated by `file_name_from_metadata()` (line 447). All components lowercase, sanitized.

## CLI Tasks

| Task | Purpose | Required Options |
|------|---------|------------------|
| `extract_new` | Process new PDFs from raw folder | `--raw_path` |
| `rename_files` | Rename based on metadata | - |
| `validate_metadata` | Check consistency | - |
| `export_excel` | Export to Excel | `--excel_output_path` |
| `copy_matching` | Copy files matching regex | `--regex_pattern`, `--copy_dest_folder` |
| `export_all_dates` | Export by date range | `--export_base_dir` |
| `check_files_exist` | Validate against schema | `--check_schema_path` (optional) |
| `pipeline` | Full end-to-end workflow | `--export_date` (optional) |
| `gmail_download` | Download email attachments from Gmail | None (uses .env) |
| `bootstrap_mappings` | Populate mappings from existing metadata | - |
| `review_mappings` | Interactive review of auto-added mappings | - |
| `add_canonical` | Add a new canonical value | `--field`, `--canonical` |

## Configuration

### Profile-Based (Recommended)

**Current setup**: `profiles/default.yaml` (migrated from `.env`)

```yaml
profile:
  name: "default"
  description: "Default configuration"

paths:
  raw: ["/Users/tsilva/Desktop/Takeout/"]
  processed: "/Users/tsilva/Google Drive/My Drive/documentor-puzzle/processed/"
  export: "/Users/tsilva/Google Drive/My Drive/documentor-puzzle/export/"

openrouter:
  model_id: "google/gemini-2.5-flash"
  api_key: "${OPENROUTER_API_KEY}"  # References .env for security

document_types:
  predefined: null  # Dynamic loading from processed metadata
```

**Usage**:
```bash
python main.py --profile default extract_new /path/to/processed
python main.py --profile personal pipeline
python main.py extract_new /path/to/processed  # Auto-uses default.yaml if available
```

**Multiple environments**: Create `profiles/personal.yaml`, `profiles/work.yaml`, etc. from templates in `profiles/*.yaml.example`

**Full docs**: See `profiles/README.md` for complete YAML schema and examples

### Legacy .env (Deprecated but Supported)

Still works for backward compatibility. `.env` at repo root:

```env
OPENROUTER_MODEL_ID=google/gemini-2.5-flash
OPENROUTER_API_KEY=sk-or-v1-...
RAW_FILES_DIR=/path/to/raw;/optional/path2
PROCESSED_FILES_DIR=/path/to/processed
EXPORT_FILES_DIR=/path/to/export
```

**Note**: If both profiles and .env exist, profiles take precedence when `--profile` is specified.

### Config Files

**Config files** in `config/` directory (gitignored, copy from `.example` files):
- `mappings.yaml` - Raw → canonical mappings for deterministic normalization (see `mappings.yaml.example`)
- `passwords.txt` - ZIP extraction passwords
- `file_check_validations.json` - File validation schema
- `document_types.json` - Fallback document types for classification
- `gmail_credentials.json` - Gmail OAuth2 client credentials (from Google Cloud Console)
- `gmail_settings.json` - Gmail download settings (legacy, use profile settings instead)
- `gmail_token.json` - Auto-generated OAuth2 refresh token

## Code Patterns

- **Progress bars**: Always use `tqdm` for loops over files
- **Error handling**: Log failures to `classification_failures.log` via `failure_logger`
- **Validators**: Pydantic `@field_validator` for normalization (currency symbols, amounts, dates)
- **LLM calls**: Use `tool_choice` for structured output, temperature=0 for determinism
- **Fallbacks**: Always fall back to `$UNKNOWN$` for unrecognized values

## Common Development Tasks

**Add new document type**: Just process documents with that type - it's automatically added from metadata
**Add new issuing party**: Same - dynamically loaded from processed metadata
**Debug classification failure**: `python scripts/debug_classification.py <pdf>` shows full LLM response
**Verify duplicate detection**: `check-hash <pdf>` shows both fast and content hashes

### Mappings Workflow

1. **Bootstrap from existing data**: `python main.py bootstrap_mappings /path/to/processed`
   - Scans existing metadata files, extracts raw → canonical pairs
   - Adds them as 'confirmed' mappings

2. **Process new documents**: `python main.py extract_new /path/to/processed --raw_path /path/to/raw`
   - Known mappings use Tier 1 (no LLM call)
   - New values go through Tier 2 (LLM), then saved as 'auto'

3. **Review auto mappings**: `python main.py review_mappings`
   - Interactive review: confirm, edit, or reject each mapping

4. **Add new canonical**: `python main.py add_canonical --field issuing_party --canonical "new-vendor"`
   - Makes a new canonical value available for future mappings

## Testing

No test suite currently. Debug scripts available in `scripts/`.

## Dependencies

Core: `openai`, `PyMuPDF (fitz)`, `pandas`, `pydantic`, `pyyaml`, `pillow`, `tqdm`, `openpyxl`, `python-dotenv`
Gmail: `google-api-python-client`, `google-auth-httplib2`, `google-auth-oauthlib`
Build: `hatchling`, Package manager: `uv`
